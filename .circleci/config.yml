version: 2
jobs:
  build:
    working_directory: ~/little_service
    docker:
      - image: python:2
      - image: mysql:latest
        environment:
        - MYSQL_ALLOW_EMPTY_PASSWORD: yes
        - MYSQL_DATABASE: little_service_db

    steps:
      - checkout
      - restore_cache:
          key: venv-{{ checksum "requirements.in" }}
      - run:
          name: install dependencies
          command: |
            echo "Creating virtualenv..."
            virtualenv venv
            source venv/bin/activate
            echo "Installing dependencies..."
            pip install pip-tools
            pip-compile --output-file requirements.txt requirements.in
            pip-sync requirements.txt
      - save_cache:
          key: venv-{{ checksum "requirements.in" }}
          paths:
            - venv
      - run:
          name: run tests
          command: |
            source venv/bin/activate
            # TODO: Use dockerize or similar to wait for DB readiness.
            sleep 5
            DJANGO_SETTINGS_MODULE=config.environments.ci python server/manage.py migrate
            DJANGO_SETTINGS_MODULE=config.environments.ci python server/manage.py test little_service_app
      - store_artifacts:
          path: test-reports/
          destination: tr1
